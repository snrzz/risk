# 金融风控监控系统 - 落地实施手册

## 一、项目概述

### 1.1 系统简介
金融风控监控系统是一个统一监控平台，用于监控O32投资交易系统、估值核算系统、风险控制系统、非标系统、关联交易系统、TA系统、COP系统等业务系统。

### 1.2 主要功能
- **统一监控**: 集中监控多个业务系统指标
- **告警管理**: 灵活的告警规则配置和多渠道通知
- **数据分析**: 指标趋势分析、异常检测
- **报告生成**: 自动生成日报、周报、月报
- **可视化**: 实时仪表盘、图表展示

---

## 二、系统架构

### 2.1 技术栈
| 层级 | 技术选型 |
|------|----------|
| 前端 | Vue3 + Element Plus + ECharts |
| 后端 | Python + FastAPI |
| 数据库 | SQLite (开发) / MySQL (生产) |
| 定时任务 | APScheduler |
| 部署 | Docker Compose |

### 2.2 目录结构
```
financial_monitoring_system/
├── docker-compose.yml          # Docker编排配置
├── config/
│   ├── settings.yaml          # 应用配置
│   └── nginx.conf             # Nginx配置
├── src/
│   ├── backend/               # 后端代码
│   │   ├── app/
│   │   │   ├── main.py        # 入口
│   │   │   ├── config.py      # 配置
│   │   │   ├── database.py    # 数据库
│   │   │   ├── models.py      # 数据模型
│   │   │   ├── schemas.py     # Pydantic模型
│   │   │   ├── routers/       # API路由
│   │   │   └── services/      # 业务逻辑
│   │   └── requirements.txt
│   └── frontend/              # 前端代码
│       ├── src/
│       │   ├── views/         # 页面组件
│       │   ├── api/           # API调用
│       │   ├── router/        # 路由
│       │   └── store/         # 状态管理
│       └── package.json
├── scripts/
│   └── init_db.py             # 数据库初始化
└── docs/
    ├── 架构设计.md
    ├── 数据库设计.sql
    └── 部署手册.md
```

---

## 三、部署步骤

### 3.1 环境要求
- Docker >= 20.10
- Docker Compose >= 2.0
- 内存 >= 4GB
- 磁盘 >= 20GB

### 3.2 快速部署

#### 步骤1: 克隆项目
```bash
cd /root/clawd
git clone <repository_url> financial_monitoring_system
cd financial_monitoring_system
```

#### 步骤2: 配置参数
编辑 `config/settings.yaml`:
```yaml
app:
  name: "金融风控监控系统"
  host: "0.0.0.0"
  port: 8000
  debug: false

database:
  type: "sqlite"  # 或 mysql
  name: "financial_monitoring.db"
```

#### 步骤3: 初始化数据库
```bash
python scripts/init_db.py init
python scripts/init_db.py seed  # 插入演示数据
```

#### 步骤4: 启动服务
```bash
docker-compose up -d
```

#### 步骤5: 访问系统
- 前端: http://localhost:8080
- API文档: http://localhost:8000/docs

### 3.3 生产环境部署

#### 使用MySQL
1. 修改 `config/settings.yaml`:
```yaml
database:
  type: "mysql"
  host: "your_mysql_host"
  port: 3306
  username: "root"
  password: "your_password"
  name: "financial_monitoring"
```

2. 启动MySQL容器:
```bash
docker run -d \
  --name mysql \
  -p 3306:3306 \
  -v mysql_data:/var/lib/mysql \
  -e MYSQL_ROOT_PASSWORD=your_password \
  mysql:8
```

#### 使用systemd管理
创建服务文件 `/etc/systemd/system/fm.service`:
```ini
[Unit]
Description=Financial Monitoring System
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
WorkingDirectory=/root/clawd/financial_monitoring_system
ExecStart=/usr/bin/docker-compose up -d
ExecStop=/usr/bin/docker-compose down
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

启用服务:
```bash
systemctl enable fm
systemctl start fm
```

---

## 四、数据对接

### 4.1 数据源类型

系统支持以下数据源类型:
| 类型 | 说明 | 配置字段 |
|------|------|----------|
| database_view | 数据库视图 | path, view_name |
| csv_file | CSV文件 | path |
| excel_file | Excel文件 | path, sheet_name |
| json_file | JSON文件 | path |
| xml_file | XML文件 | path |
| log_file | 日志文件 | path |

### 4.2 配置数据源

#### 方式1: 数据库视图
```sql
-- 创建视图示例
CREATE VIEW v_o32_positions AS
SELECT 
    stock_code,
    stock_name,
    SUM(position) as total_position,
    SUM(market_value) as market_value
FROM positions
GROUP BY stock_code;
```

在Web界面配置:
```json
{
  "path": "/path/to/database.db",
  "view_name": "v_o32_positions"
}
```

#### 方式2: CSV文件
```json
{
  "path": "/data/o32/positions_20240101.csv"
}
```

文件格式:
```csv
date,stock_code,position,market_value
2024-01-01,600000,10000,150000.00
```

### 4.3 配置指标

在Web界面配置指标映射:
| 字段 | 说明 |
|------|------|
| code | 指标编码 (英文唯一) |
| name | 指标名称 |
| category | 分类 (trading/valuation/risk等) |
| field_name | 数据源字段名 |
| unit | 单位 |
| aggregation_type | 聚合方式 (sum/avg/last等) |

---

## 五、告警配置

### 5.1 条件类型

| 类型 | 配置示例 |
|------|----------|
| threshold | `{"operator": ">", "threshold": 100}` |
| range | `{"min": 10, "max": 100}` |
| change_rate | `{"period": "1h", "threshold": 0.1}` |
| trend | `{"direction": "up", "consecutive": 3}` |

### 5.2 告警级别

| 级别 | 名称 | 响应时间 | 场景 |
|------|------|---------|------|
| P1 | 紧急 | 立即 | 系统宕机、重大风险 |
| P2 | 严重 | 15分钟 | 风险超标、异常交易 |
| P3 | 警告 | 1小时 | 指标接近阈值 |
| P4 | 提示 | 24小时 | 趋势变化 |

### 5.3 通知渠道配置

#### 飞书
```json
{
  "webhook_url": "https://open.feishu.cn/open-apis/bot/v2/hook/xxx"
}
```

#### 企业微信
```json
{
  "key": "your_bot_key"
}
```

#### 邮件
```json
{
  "smtp_host": "smtp.example.com",
  "smtp_port": 465,
  "username": "alert@example.com",
  "password": "your_password",
  "from_address": "alert@example.com",
  "to_addresses": ["user@example.com"]
}
```

---

## 六、维护管理

### 6.1 日志查看
```bash
# 后端日志
docker logs -f financial-monitoring-backend

# Nginx日志
docker exec financial-monitoring-frontend cat /var/log/nginx/access.log
```

### 6.2 数据备份
```bash
# 备份数据库
cp data/financial_monitoring.db backup/financial_monitoring_$(date +%Y%m%d).db

# 备份配置
cp config/settings.yaml backup/settings_$(date +%Y%m%d).yaml
```

### 6.3 版本升级
```bash
cd /root/clawd/financial_monitoring_system
git pull
docker-compose down
docker-compose up -d --build
```

### 6.4 监控检查
```bash
# 检查服务状态
docker-compose ps

# 检查健康状态
curl http://localhost:8000/health

# 检查磁盘空间
df -h
```

---

## 七、常见问题

### Q1: 启动失败怎么办?
1. 检查端口是否被占用: `netstat -tlnp | grep 8000`
2. 检查Docker是否运行: `systemctl status docker`
3. 查看详细日志: `docker-compose logs`

### Q2: 数据库连接失败?
1. 确认数据库服务已启动
2. 检查配置文件中的连接信息
3. 查看后端日志: `docker logs financial-monitoring-backend`

### Q3: 告警通知收不到?
1. 检查通知渠道配置是否正确
2. 测试渠道连接: 在通知渠道页面点击"测试"
3. 检查告警规则是否启用
4. 确认告警触发条件是否满足

### Q4: 如何添加新的数据源?
1. 在Web界面"数据源管理"点击"新增"
2. 选择数据源类型
3. 填写连接信息
4. 配置指标映射
5. 保存并测试连接

---

## 八、技术支持

如有问题，请联系:
- 文档: 查看 docs/ 目录下的文档
- 日志: 通过 `docker logs` 查看详细日志
