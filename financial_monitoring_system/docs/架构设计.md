# 金融风控监控系统 - 架构设计

## 一、系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            金融风控监控系统                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                          数据采集层 (Data Ingestion)                     │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │  数据视图   │  │  CSV/Excel  │  │  JSON/XML   │  │  日志文件   │    │ │
│  │  │  (DB View)  │  │   (Files)   │  │   (Files)   │  │   (Logs)    │    │ │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │ │
│  │         │                │                │                │            │ │
│  │         └────────────────┴────────────────┴────────────────┘            │ │
│  │                                  │                                       │ │
│  │                    ┌─────────────┴─────────────┐                        │ │
│  │                    │   统一采集适配器 (Adapter)  │                        │ │
│  │                    │   - 数据库连接池           │                        │ │
│  │                    │   - 文件监控轮询           │                        │ │
│  │                    │   - 增量同步机制           │                        │ │
│  │                    └─────────────┬─────────────┘                        │ │
│  └──────────────────────────────────┼────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                          数据存储层 (Data Storage)                       │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                         │ │
│  │  ┌─────────────────────┐    ┌─────────────────────┐                    │ │
│  │  │    SQLite/MySQL     │    │   文件存储 (本地)    │                    │ │
│  │  │  - 配置信息          │    │  - 原始数据备份     │                    │ │
│  │  │  - 监控指标历史      │    │  - 导出报告         │                    │ │
│  │  │  - 告警记录          │    │  - 日志文件         │                    │ │
│  │  │  - 用户权限          │    │                     │                    │ │
│  │  └─────────────────────┘    └─────────────────────┘                    │ │
│  └──────────────────────────────────┬────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         分析引擎层 (Analysis Engine)                     │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                         │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │                        核心分析模块                                │  │ │
│  │  ├───────────────────────────────────────────────────────────────────┤  │ │
│  │  │                                                                   │  │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │ │
│  │  │  │  指标计算   │  │  异常检测   │  │  风险分析   │               │  │ │
│  │  │  │  - 汇总统计 │  │  - 阈值检测 │  │  - VaR计算  │               │  │ │
│  │  │  │  - 环比同比 │  │  - 趋势偏离 │  │  - 集中度   │               │  │ │
│  │  │  │  - 移动平均 │  │  - 统计异常 │  │  - 压力测试 │               │  │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘               │  │ │
│  │  │                                                                   │  │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │ │
│  │  │  │  规则引擎   │  │  预测模型   │  │  报告生成   │               │  │ │
│  │  │  │  - 组合条件 │  │  - 时间序列 │  │  - 日报周报 │               │  │ │
│  │  │  │  - 优先级   │  │  - 异常预测 │  │  - 风控报告 │               │  │ │
│  │  │  │  - 联动触发 │  │  - 趋势预测 │  │  - 监管报表 │               │  │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘               │  │ │
│  │  │                                                                   │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        预警通知层 (Alert & Notify)                       │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                         │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │                      通知通道 (多渠道)                             │  │ │
│  │  ├───────────────────────────────────────────────────────────────────┤  │ │
│  │  │                                                                   │  │ │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │ │
│  │  │  │  飞书    │  │ 企业微信 │  │   邮件   │  │   短信   │          │  │ │
│  │  │  │ (Lark)  │  │ (WeCom)  │  │  (Email) │  │  (SMS)   │          │  │ │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │  │ │
│  │  │                                                                   │  │ │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │ │
│  │  │  │  钉钉    │  │ Telegram │  │  Webhook │  │  站内信  │          │  │ │
│  │  │  │ (Ding)  │  │          │  │          │  │ (In-App) │          │  │ │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘          │  │ │
│  │  │                                                                   │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                         │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │                      告警管理                                      │  │ │
│  │  │  - 告警抑制 (相同告警合并)                                         │  │ │
│  │  │  - 升级机制 (未确认自动升级)                                       │  │ │
│  │  │  - 静默规则 (维护窗口)                                             │  │ │
│  │  │  - 告警历史 (统计分析)                                            │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                     │                                        │
│                                     ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        Web管理面板 (Management UI)                      │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                         │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │                        前端功能模块                                │  │ │
│  │  ├───────────────────────────────────────────────────────────────────┤  │ │
│  │  │                                                                   │  │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │ │
│  │  │  │  仪表盘     │  │  监控配置   │  │  告警中心   │               │  │ │
│  │  │  │  Dashboard │  │  Config     │  │  Alerts     │               │  │ │
│  │  │  │  - 实时指标 │  │  - 数据源   │  │  - 实时告警 │               │  │ │
│  │  │  │  - 趋势图   │  │  - 规则配置 │  │  - 历史记录 │               │  │ │
│  │  │  │  - 风险视图 │  │  - 通知设置 │  │  - 统计分析 │               │  │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘               │  │ │
│  │  │                                                                   │  │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │ │
│  │  │  │  数据查询   │  │  报告中心   │  │  系统管理   │               │  │ │
│  │  │  │  Query     │  │  Reports    │  │  Admin      │               │  │ │
│  │  │  │  - 自由查询 │  │  - 日报周报 │  │  - 用户权限 │               │  │ │
│  │  │  │  - 导出Excel│  │  - 监管报表 │  │  - 系统配置 │               │  │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘               │  │ │
│  │  │                                                                   │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         任务调度层 (Scheduler)                           │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │  数据采集   │  │  指标计算   │  │  规则检查   │  │  报告生成   │    │ │
│  │  │  (每1-5分钟)│  │  (每5-15分) │  │  (实时/定时)│  │  (日报周报) │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 二、技术选型

| 层级 | 技术栈 | 说明 |
|------|--------|------|
| 后端框架 | Python + FastAPI | 高性能异步API框架 |
| 定时任务 | APScheduler | 强大的任务调度 |
| 数据库 | SQLite (开发) / MySQL (生产) | 关系型数据存储 |
| 前端框架 | Vue3 + Element Plus | 现代Web界面 |
| 图表库 | ECharts | 丰富的可视化 |
| 通知渠道 | 飞书/企业微信/邮件/钉钉 | 多渠道告警 |
| 部署方式 | Docker Compose | 容器化部署 |
| 进程管理 | Gunicorn + Uvicorn | ASGI服务器 |

## 三、数据采集设计

### 3.1 支持的数据源类型

```python
class DataSourceType(Enum):
    DATABASE_VIEW = "database_view"    # 数据库视图
    CSV_FILE = "csv_file"              # CSV文件
    EXCEL_FILE = "excel_file"          # Excel文件
    JSON_FILE = "json_file"            # JSON文件
    XML_FILE = "xml_file"              # XML文件
    LOG_FILE = "log_file"              # 日志文件
    API_ENDPOINT = "api_endpoint"      # API接口(预留)
```

### 3.2 数据对接规范

每个业务系统需要提供：

1. **数据库视图方式**：
   - 提供只读数据库访问账号
   - 创建标准化的数据视图
   - 视图包含：业务字段 + 状态字段 + 时间戳字段

2. **文件方式**：
   - 支持CSV/Excel/JSON格式
   - 文件命名规范：`{系统名}_{数据类型}_{日期}.{ext}`
   - 提供文件目录供系统轮询读取
   - 支持FTP/SMB/NFS等共享方式

## 四、监控指标体系

### 4.1 投资交易系统(O32)

| 指标分类 | 指标名称 | 计算方式 | 告警阈值 |
|---------|---------|---------|---------|
| 持仓监控 | 单只股票持仓占比 | 持仓市值/总资产 | >10% 警告, >15% 严重 |
| 持仓监控 | 行业集中度 | 行业持仓/总资产 | >30% 警告 |
| 资金监控 | 资金使用率 | 已用资金/可用资金 | >90% 警告 |
| 成交监控 | 单日成交金额 | 实时统计 | 异常放大/缩小 |
| 头寸监控 | 敞口监控 | 多头-空头 | 超阈值告警 |

### 4.2 估值核算系统

| 指标分类 | 指标名称 | 计算方式 | 告警阈值 |
|---------|---------|---------|---------|
| 净值监控 | 单位净值 | 资产净值/份额 | 日波动 >3% |
| 净值监控 | 累计净值 | 历史净值累计 | 日波动 >3% |
| 资产监控 | 资产规模 | 期末资产总值 | 日变化 >10% |
| 负债监控 | 负债比例 | 负债/资产 | >5% 警告 |
| 估值核对 | 账实差异 | 估值-市值 | 差异 >0.5% |

### 4.3 风险控制系统

| 指标分类 | 指标名称 | 计算方式 | 告警阈值 |
|---------|---------|---------|---------|
| 风险敞口 | VaR (95%) | 历史模拟法 | 超风险限额 |
| 风险敞口 | VaR (99%) | 历史模拟法 | 超风险限额 |
| 集中度 | 前10大持仓 | 合计占比 | >50% 警告 |
| 集中度 | 单一对手方 | 暴露金额 | 超限额 |
| 杠杆监控 | 资产负债率 | 负债/权益 | >150% 警告 |
| 流动性 | 流动性覆盖率 | 高流动性资产/30日净流出 | <100% 警告 |

### 4.4 非标系统

| 指标分类 | 指标名称 | 计算方式 | 告警阈值 |
|---------|---------|---------|---------|
| 规模监控 | 非标资产占比 | 非标资产/总资产 | >20% 警告 |
| 期限监控 | 平均久期 | 加权平均期限 | 偏离目标 |
| 信用监控 | 信用评级分布 | 各评级占比 | 单一评级 >80% |
| 到期监控 | 近期到期量 | 30天内到期金额 | 过于集中 |

### 4.5 关联交易系统

| 指标分类 | 指标名称 | 计算方式 | 告警阈值 |
|---------|---------|---------|---------|
| 关联交易 | 关联金额占比 | 关联金额/总交易 | >10% 需关注 |
| 关联交易 | 关联笔数 | 关联交易数量 | 异常增长 |
| 关联方 | 关联方持仓 | 关联方持股比例 | >5% 需披露 |
| 公平性 | 关联交易价格 | vs 市场价 | 偏离 >5% |

### 4.6 TA系统

| 指标分类 | 指标名称 | 计算方式 | 告警阈值 |
|---------|---------|---------|---------|
| 份额监控 | 基金份额 | 期末份额 | 日变化 >10% |
| 资金监控 | 申购赎回 | 净流入/净流出 | 异常大额 |
| 注册监控 | 开户数量 | 日新增开户 | 异常增长 |
| 对账监控 | 账务核对 | 差异笔数 | 有差异 |

### 4.7 COP系统

| 指标分类 | 指标名称 | 计算方式 | 告警阈值 |
|---------|---------|---------|---------|
| 运营效率 | 处理时效 | 平均处理时间 | 超时告警 |
| 运营效率 | 失败率 | 失败笔数/总笔数 | >1% 警告 |
| 完整性 | 数据完整率 | 完整字段/总字段 | <99% |
| 及时性 | 报送及时率 | 按时报送/应报送 | <100% |

## 五、告警级别定义

| 级别 | 名称 | 颜色 | 响应时间 | 说明 |
|-----|------|------|---------|------|
| P1 | 紧急 | 红色 | 立即 | 系统宕机、重大风险 |
| P2 | 严重 | 橙色 | 15分钟 | 风险超标、异常交易 |
| P3 | 警告 | 黄色 | 1小时 | 指标接近阈值 |
| P4 | 提示 | 蓝色 | 24小时 | 趋势变化、需关注 |

## 六、部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         互联网/内网                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      负载均衡 (Nginx可选)                        │
└─────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  Web Server     │ │  API Server     │ │  Worker Nodes   │
│  (前端服务)      │ │  (后端API)      │ │  (Celery任务)   │
│  - Vue3         │ │  - FastAPI      │ │  - 数据采集     │
│  - 静态资源      │ │  - REST API     │ │  - 告警计算     │
│  - 端口: 8080   │ │  - 端口: 8000   │ │  - 报告生成     │
└─────────────────┘ └─────────────────┘ └─────────────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据库层                                    │
│  ┌─────────────────┐         ┌─────────────────┐               │
│  │  SQLite/MySQL   │         │  文件存储       │               │
│  │  - 配置库       │         │  - 数据备份     │               │
│  │  - 监控数据     │         │  - 报告文件     │               │
│  │  - 告警记录     │         │  - 日志         │               │
│  └─────────────────┘         └─────────────────┘               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据源 (各业务系统)                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ O32系统  │ │ 估值系统 │ │ 风控系统 │ │ 非标系统 │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
└─────────────────────────────────────────────────────────────────┘
```

## 七、项目目录结构

```
financial_monitoring_system/
├── docker-compose.yml          # Docker编排配置
├── docker/
│   ├── backend/Dockerfile     # 后端Dockerfile
│   └── frontend/Dockerfile    # 前端Dockerfile
├── src/
│   ├── backend/               # 后端项目
│   │   ├── app/
│   │   │   ├── main.py        # FastAPI入口
│   │   │   ├── config.py      # 配置管理
│   │   │   ├── database.py    # 数据库连接
│   │   │   ├── models/        # 数据模型
│   │   │   ├── routers/       # API路由
│   │   │   ├── services/      # 业务逻辑
│   │   │   ├── schedulers/    # 定时任务
│   │   │   └── utils/         # 工具函数
│   │   ├── requirements.txt   # Python依赖
│   │   └── tests/             # 测试用例
│   └── frontend/              # 前端项目
│       ├── public/
│       ├── src/
│       │   ├── api/           # API调用
│       │   ├── components/    # 组件
│       │   ├── views/         # 页面
│       │   ├── router/        # 路由
│       │   ├── store/         # 状态管理
│       │   └── utils/         # 工具
│       ├── package.json
│       └── vite.config.js
├── scripts/
│   ├── init_db.py             # 初始化数据库
│   └── backup.sh              # 备份脚本
├── config/
│   ├── settings.yaml          # 应用配置
│   └── alerts.yaml            # 告警规则配置
├── data/                      # 数据目录
│   ├── raw/                   # 原始数据
│   ├── processed/             # 处理后数据
│   └── exports/               # 导出文件
├── logs/                      # 日志目录
└── docs/                      # 文档
    ├── 部署手册.md
    ├── 用户手册.md
    ├── API文档.md
    └── 数据对接规范.md
```
